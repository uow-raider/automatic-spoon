<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>NOVA RAIDER V6 - Legacy Sweep</title>
    <style>
        :root {
            --bg: #08080c;
            --accent: #00d4ff;
            --danger: #ff0055;
            --card: #11111d;
            --border: #1f1f35;
        }

        body {
            font-family: 'Consolas', 'Meiryo', sans-serif;
            background-color: var(--bg);
            color: #ccc;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: var(--card);
            padding: 25px;
            border-radius: 8px;
            border: 1px solid var(--border);
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        .title { text-align: center; color: var(--accent); font-size: 24px; letter-spacing: 5px; margin-bottom: 20px; text-shadow: 0 0 10px var(--accent); }

        .form-section { margin-bottom: 15px; }
        label { display: block; font-size: 11px; color: var(--accent); margin-bottom: 5px; font-weight: bold; }

        textarea, input, select {
            width: 100%; padding: 10px; background: #000; border: 1px solid var(--border);
            border-radius: 4px; color: #fff; box-sizing: border-box; font-size: 12px; outline: none;
        }

        .flex-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .flex-1 { flex: 1; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 5px; }
        .btn-main { background: var(--accent); color: #000; }
        .btn-stop { background: var(--danger); color: #fff; margin-top: 10px; }
        .btn-util { background: #1a1a2a; color: var(--accent); border: 1px solid var(--accent); font-size: 11px; }

        #log {
            margin-top: 20px; height: 180px; background: #000; border: 1px solid var(--border);
            padding: 10px; font-size: 11px; overflow-y: auto; color: #999;
        }
        .log-hit { color: var(--accent); }
    </style>
</head>
<body>

<div class="container">
    <div class="title">NOVA RAIDER V6</div>
    <p style="text-align:center; font-size:10px; margin-top:-15px; opacity:0.7;">EXISTING MESSAGE SWEEP SYSTEM</p>

    <div class="form-section">
        <label>使用トークン (1行1つ)</label>
        <textarea id="tokens" style="height: 50px;"></textarea>
    </div>

    <div class="flex-row">
        <div class="flex-1">
            <label>ターゲットサーバーID</label>
            <input type="text" id="guildId">
            <button class="btn-util" onclick="setupServer()">チャンネルリスト取得</button>
        </div>
        <div class="flex-1">
            <label>遡り件数 (1チャンネルにつき何件にリプライするか)</label>
            <input type="number" id="limitPerCh" value="50">
        </div>
    </div>

    <div class="flex-row">
        <div class="flex-1">
            <label>ターゲットチャンネルID</label>
            <textarea id="channels" style="height: 80px;"></textarea>
        </div>
        <div class="flex-1">
            <label>メンション対象ID</label>
            <textarea id="members" style="height: 80px;"></textarea>
        </div>
    </div>

    <div class="flex-row" style="background: rgba(0,212,255,0.05); padding: 10px; border-radius: 4px;">
        <div class="flex-1">
            <label>本文</label>
            <input type="text" id="msgBody" value="REPLY SWEEP ATTACHED">
        </div>
        <div style="width: 80px;">
            <label>言語</label>
            <select id="lang">
                <option value="km">クメール語</option>
                <option value="ar">アラビア語</option>
                <option value="ko">韓国語</option>
            </select>
        </div>
        <div style="width: 60px;">
            <label>文字数</label>
            <input type="number" id="strLen" value="15">
        </div>
    </div>

    <button id="start" class="btn btn-main" onclick="startSweep()">全既存メッセージへのリプライ開始</button>
    <button id="stop" class="btn btn-stop" onclick="stopSweep()" disabled>停止</button>

    <div id="log"></div>
</div>

<script>
    let sweeping = false;
    const charSets = { km: "កខគឃងចឆជឈញដឋឌឍណតថទធនបផពភមយរលវសហឡអ", ar: "ابتثجحخدذرزسشصضطظعغفقكلمنهوي", ko: "가나다라마바사아자차카타파하" };

    function log(m, c="") {
        const l = document.getElementById('log');
        const d = document.createElement('div');
        if(c) d.style.color = c;
        d.innerHTML = `[${new Date().toLocaleTimeString()}] ${m}`;
        l.prepend(d);
    }

    async function setupServer() {
        const t = document.getElementById('tokens').value.split('\n')[0].trim();
        const g = document.getElementById('guildId').value.trim();
        if(!t || !g) return alert("トークンとサーバーIDが必要です");
        try {
            const r = await fetch(`https://discord.com/api/v9/guilds/${g}/channels`, { headers: { 'Authorization': t } });
            const data = await r.json();
            document.getElementById('channels').value = data.filter(c => [0,5].includes(c.type)).map(c => c.id).join('\n');
            const rM = await fetch(`https://discord.com/api/v9/guilds/${g}/members?limit=1000`, { headers: { 'Authorization': t } });
            const mData = await rM.json();
            document.getElementById('members').value = mData.map(m => m.user.id).join('\n');
            log("サーバーデータ同期完了", "var(--accent)");
        } catch(e) { log("取得失敗", "var(--danger)"); }
    }

    function getRand() {
        const s = charSets[document.getElementById('lang').value];
        let r = "";
        for(let i=0; i<parseInt(document.getElementById('strLen').value); i++) r += s.charAt(Math.floor(Math.random()*s.length));
        return r;
    }

    async function startSweep() {
        sweeping = true;
        document.getElementById('start').disabled = true;
        document.getElementById('stop').disabled = false;
        
        const tokens = document.getElementById('tokens').value.split('\n').filter(x => x.trim());
        const channels = document.getElementById('channels').value.split('\n').filter(x => x.trim());
        const members = document.getElementById('members').value.split('\n').filter(x => x.trim());
        const limit = parseInt(document.getElementById('limitPerCh').value);

        log("全メッセージ遡及リプライを開始します...", "yellow");

        for (const chId of channels) {
            if (!sweeping) break;
            log(`チャンネル: ${chId} の過去ログをスキャン中...`);

            try {
                // 過去ログを取得
                const res = await fetch(`https://discord.com/api/v9/channels/${chId}/messages?limit=${limit}`, {
                    headers: { 'Authorization': tokens[0] }
                });
                const messages = await res.json();

                if (Array.isArray(messages)) {
                    for (const msg of messages) {
                        if (!sweeping) break;
                        
                        // リプライ送信
                        const t = tokens[Math.floor(Math.random() * tokens.length)];
                        const mentions = members.sort(() => 0.5 - Math.random()).slice(0, 3).map(id => `<@${id}>`).join(" ");
                        
                        await fetch(`https://discord.com/api/v9/channels/${chId}/messages`, {
                            method: 'POST',
                            headers: { 'Authorization': t, 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                content: `${mentions} ${document.getElementById('msgBody').value}\n# ${getRand()}`,
                                message_reference: { message_id: msg.id }
                            })
                        });
                        log(`完了: MessageID(${msg.id}) へのリプライ`, "var(--accent)");
                        await new Promise(r => setTimeout(r, 1000)); // レート制限回避用ディレイ
                    }
                }
            } catch (e) { log(`エラー: ${chId} の処理に失敗`, "var(--danger)"); }
        }
        log("すべての遡及リプライ処理が終了しました。", "var(--accent)");
        stopSweep();
    }

    function stopSweep() {
        sweeping = false;
        document.getElementById('start').disabled = false;
        document.getElementById('stop').disabled = true;
        log("プロセスを停止しました。");
    }
</script>
</body>
</html>
